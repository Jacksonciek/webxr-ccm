<!DOCTYPE html>
<html lang="id" oncontextmenu="return false">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>AR Wall 3D</title>
<style>
/* Block ALL long-press popups everywhere */
*{
  margin:0;padding:0;box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
  -webkit-touch-callout:none;
  -webkit-user-select:none;
  -khtml-user-select:none;
  -moz-user-select:none;
  -ms-user-select:none;
  user-select:none;
  touch-action:manipulation;
}
canvas,video,img{
  pointer-events:none;
  -webkit-user-drag:none;
  -khtml-user-drag:none;
  user-drag:none;
}
canvas{ pointer-events:all !important; touch-action:none !important; }

body{
  background:#07070f;
  font-family:-apple-system,'Segoe UI',system-ui,sans-serif;
  color:#fff;overflow:hidden;
  width:100vw;height:100dvh;
}

/* â”€â”€ SPLASH â”€â”€ */
#splash{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100dvh;padding:28px;gap:16px;
  background:radial-gradient(ellipse 90% 55% at 50% -5%,#1d0b45,#07070f 65%);
}
.slogo{font-size:50px;filter:drop-shadow(0 0 24px #9944ffbb)}
h1{
  font-size:24px;font-weight:900;letter-spacing:-0.6px;text-align:center;
  background:linear-gradient(130deg,#bf88ff 20%,#ff66cc 80%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.ssub{font-size:13px;color:#666;text-align:center;line-height:1.65;max-width:290px}
.card{
  background:#0f0f1d;border:1px solid #1f1f3a;border-radius:20px;
  padding:16px;width:100%;max-width:340px;
}
.clbl{font-size:10px;color:#555;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.pbox{
  width:100%;aspect-ratio:1/1;border-radius:12px;overflow:hidden;
  background:#0a0a18;border:2px dashed #1f1f3a;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:border-color .2s;
}
.pbox:active{border-color:#9944ff}
.pbox img{width:100%;height:100%;object-fit:cover;display:none;pointer-events:none}
.ph{display:flex;flex-direction:column;align-items:center;gap:6px;color:#333;font-size:11px}
.phico{font-size:30px}
input[type=file]{display:none}
.sbtn{
  background:linear-gradient(135deg,#4422ee,#aa44dd);border:none;color:#fff;
  border-radius:16px;padding:16px;font-size:16px;font-weight:800;cursor:pointer;
  width:100%;max-width:340px;box-shadow:0 6px 28px #6622ee44;
  transition:transform .12s,opacity .2s;
}
.sbtn:active{transform:scale(.97);opacity:.88}
.tags{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.tag{
  background:#0f0f1d;border:1px solid #1f1f3a;border-radius:50px;
  padding:5px 12px;font-size:11px;color:#666
}
.tag b{color:#99aaff;font-weight:600}

/* â”€â”€ AR SCREEN â”€â”€ */
#ar{display:none;position:fixed;inset:0;z-index:100}
#vid{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1}
#cv{
  position:absolute;inset:0;width:100%;height:100%;z-index:2;
  touch-action:none;
}

/* Top bar */
#topbar{
  position:absolute;top:0;left:0;right:0;z-index:10;
  padding:safe-area-inset-top 20px 12px;
  padding-top:max(env(safe-area-inset-top,0px),18px);
  display:flex;align-items:center;justify-content:space-between;
  background:linear-gradient(to bottom,rgba(0,0,0,.72),transparent);
  pointer-events:none;
}
.tbtitle{font-size:14px;font-weight:700;opacity:.9}
.tbclose{
  background:rgba(255,255,255,.1);backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.14);color:#fff;
  border-radius:50px;padding:7px 16px;font-size:12px;cursor:pointer;
  pointer-events:all;
}

/* Mode badge */
#badge{
  position:absolute;top:68px;left:50%;transform:translateX(-50%);z-index:10;
  padding:7px 18px;border-radius:50px;font-size:12px;font-weight:700;
  backdrop-filter:blur(12px);border:1px solid;white-space:nowrap;pointer-events:none;
  transition:background .3s,color .3s;
}
#badge.edit{background:rgba(255,175,0,.18);border-color:rgba(255,200,0,.38);color:#ffd060}
#badge.locked{background:rgba(0,210,100,.18);border-color:rgba(0,230,110,.38);color:#44ffaa}

/* Hint toast */
#hint{
  position:absolute;top:112px;left:50%;transform:translateX(-50%);z-index:10;
  background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.08);border-radius:50px;
  padding:6px 16px;font-size:11px;color:#bbb;
  white-space:nowrap;pointer-events:none;
  transition:opacity .5s;
}

/* Bottom panel */
#panel{
  position:absolute;bottom:0;left:0;right:0;z-index:10;
  padding:14px 14px max(env(safe-area-inset-bottom,0px),28px);
  background:linear-gradient(to top,rgba(0,0,0,.85) 65%,transparent);
  display:flex;flex-direction:column;gap:9px;align-items:center;
}
.btnrow{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
.abtn{
  background:rgba(255,255,255,.1);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.14);color:#fff;
  border-radius:50px;padding:11px 16px;font-size:12px;font-weight:600;
  cursor:pointer;transition:background .15s;white-space:nowrap;
}
.abtn:active{background:rgba(255,255,255,.24)}
.abtn.green{background:rgba(20,180,80,.35);border-color:rgba(40,210,100,.4)}
.abtn.red{background:rgba(180,20,20,.35);border-color:rgba(220,50,50,.35)}
.abtn.blue{background:rgba(40,80,220,.35);border-color:rgba(70,110,240,.4)}

/* FOV calibration strip */
.fovrow{
  display:flex;align-items:center;gap:9px;
  background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
  border-radius:50px;padding:7px 16px;width:100%;max-width:330px;
}
.fovrow label{font-size:10px;color:#666;white-space:nowrap}
input[type=range]{
  flex:1;-webkit-appearance:none;appearance:none;
  height:3px;background:rgba(255,255,255,.18);border-radius:99px;outline:none;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:22px;height:22px;border-radius:50%;
  background:linear-gradient(135deg,#7733ff,#dd55ff);
  box-shadow:0 0 8px #7733ff55;cursor:pointer;
}

/* iOS permission overlay */
#permOvl{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.88);backdrop-filter:blur(20px);
  flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:40px;
}
.picn{font-size:50px}
.ptitle{font-size:19px;font-weight:800;text-align:center}
.psub{font-size:13px;color:#888;text-align:center;line-height:1.65;max-width:280px}
.pbtn{
  background:linear-gradient(135deg,#4422ee,#aa44dd);border:none;color:#fff;
  border-radius:14px;padding:14px 30px;font-size:15px;font-weight:700;cursor:pointer;
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• SPLASH â•â•â•â•â•â•â•â•â•â• -->
<div id="splash">
  <div class="slogo">ğŸ–¼ï¸</div>
  <h1>AR Wall 3D</h1>
  <p class="ssub">Drag 4 sudut ke pojok foto di dinding, kunci, lalu gerakkan HP â€” foto tetap stay di tempat.</p>

  <div class="card">
    <div class="clbl">Pilih Foto</div>
    <div class="pbox" onclick="document.getElementById('fi').click()">
      <div class="ph" id="ph">
        <span class="phico">ğŸ“‚</span>
        Ketuk untuk pilih foto
      </div>
      <img id="prevImg" draggable="false"/>
    </div>
    <input type="file" id="fi" accept="image/*" onchange="onFile(event)"/>
  </div>

  <button class="sbtn" onclick="startAR()">ğŸ“· Mulai AR 3D</button>

  <div class="tags">
    <div class="tag"><b>âœ“</b> iOS Safari</div>
    <div class="tag"><b>âœ“</b> Android Chrome</div>
    <div class="tag"><b>âœ“</b> 4-Corner Warp</div>
    <div class="tag"><b>âœ“</b> XYZ Gyro Lock</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• iOS PERMISSION â•â•â•â•â•â•â•â•â•â• -->
<div id="permOvl">
  <div class="picn">ğŸ”„</div>
  <div class="ptitle">Izin Sensor Gerak</div>
  <div class="psub">iOS butuh izin gyroscope agar foto bisa stay di dinding saat HP digerakkan.</div>
  <button class="pbtn" onclick="reqPerm()">Izinkan Sensor</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• AR SCREEN â•â•â•â•â•â•â•â•â•â• -->
<div id="ar">
  <video id="vid" autoplay playsinline muted></video>
  <canvas id="cv"></canvas>

  <div id="topbar">
    <div class="tbtitle">ğŸ–¼ï¸ AR Wall 3D</div>
    <div class="tbclose" onclick="stopAR()">âœ• Keluar</div>
  </div>

  <div id="badge" class="edit">âœï¸ Edit â€” Drag 4 Sudut</div>
  <div id="hint">Drag sudut berwarna Â· Drag tengah untuk geser semua</div>

  <div id="panel">
    <div class="fovrow">
      <label>ğŸ“ Kalibrasi FOV</label>
      <input type="range" id="fovR" min="40" max="100" value="65" oninput="HFOV=+this.value*DEG"/>
    </div>
    <div class="btnrow">
      <div class="abtn blue" onclick="resetCorners()">â†º Reset</div>
      <div class="abtn" onclick="doFlip()">â‡„ Flip</div>
      <div id="lockBtn" class="abtn green" onclick="toggleLock()">ğŸ“Œ Kunci 3D</div>
      <div class="abtn" onclick="saveSnap()">ğŸ’¾ Simpan</div>
      <div class="abtn red" onclick="stopAR()">âœ•</div>
    </div>
  </div>
</div>

<script>
'use strict';
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   GLOBAL BLOCK: prevent ANY long-press popup
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('contextmenu', e=>e.preventDefault(), true);
document.addEventListener('touchstart',  e=>{ /* handled per-canvas */ }, {passive:false});
window.addEventListener('selectstart', e=>e.preventDefault(), true);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONSTANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DEG  = Math.PI/180;
const MESH = 16;        // perspective warp mesh density
const HIT_R = 34;       // finger hit radius for corner handles (px)
const COLORS = ['#ff4444','#4488ff','#44ff88','#ffcc00']; // TL TR BR BL
const LABELS = ['TL','TR','BR','BL'];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let HFOV = 65*DEG;       // horizontal field of view (adjustable)

let camStream  = null;
let animId     = null;
let canvas, ctx, W, H;

const img      = new Image();
img.crossOrigin = 'anonymous';
let imgFlip    = false;

// Edit-mode corners: [{x,y}, ...] order: TL TR BR BL
let corners    = [];

// Locked-mode: 4 world-space unit direction vectors
let locked     = null;  // null = edit, array[4] = locked

// Gyro state
let oA=0, oB=Math.PI/2, oG=0;
let alphaOff   = null;
let hasOri     = false;

// Pointer tracking (unified mouse + touch)
let activeIdx  = -1;   // which corner is being dragged (-1=none, 4=move-all)
let moveStart  = null; // {x,y} pointer start for move-all
let cornersSnap= null; // snapshot of corners at move-all start

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MATH HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const norm = v=>{const l=Math.hypot(...v);return l<1e-9?[0,0,1]:v.map(x=>x/l)};
const mv   = (M,v)=>[M[0]*v[0]+M[1]*v[1]+M[2]*v[2], M[3]*v[0]+M[4]*v[1]+M[5]*v[2], M[6]*v[0]+M[7]*v[1]+M[8]*v[2]];
const mt   = M=>[M[0],M[3],M[6],M[1],M[4],M[7],M[2],M[5],M[8]];

// W3C DeviceOrientation rotation matrix
function buildR(a,b,g){
  const ca=Math.cos(a),sa=Math.sin(a),cb=Math.cos(b),sb=Math.sin(b),cg=Math.cos(g),sg=Math.sin(g);
  return[ca*cg-sa*sb*sg,-sa*cb,ca*sg+sa*sb*cg,
         sa*cg+ca*sb*sg, ca*cb,sa*sg-ca*sb*cg,
        -cb*sg,           sb,  cb*cg];
}

// Screen orientation correction angle
function screenAng(){
  return((((screen.orientation&&screen.orientation.angle)||window.orientation||0)%360)+360)%360;
}

// 2D screen pixel â†’ unit ray in device camera frame (-Z forward)
function px2ray(sx,sy){
  const vfov=HFOV*(H/W);
  let nx=(sx/W*2-1)*Math.tan(HFOV/2);
  let ny=-(sy/H*2-1)*Math.tan(vfov/2);
  const sa=screenAng();
  if(sa===90) {[nx,ny]=[ny,-nx]}
  else if(sa===270){[nx,ny]=[-ny,nx]}
  else if(sa===180){nx=-nx;ny=-ny}
  return norm([nx,ny,-1]);
}

// Screen pixel â†’ world-space unit direction
function px2world(sx,sy){
  const R=buildR(oA,oB,oG);
  return norm(mv(R,px2ray(sx,sy)));
}

// World-space direction â†’ screen pixel (returns {x,y} or null if behind)
function world2px(wd){
  const R=buildR(oA,oB,oG);
  const Rt=mt(R);
  const d=mv(Rt,wd);
  if(d[2]>=-0.005) return null;  // behind or on camera plane
  const dep=-d[2];
  const vfov=HFOV*(H/W);
  let lx=d[0]/dep, ly=d[1]/dep;
  const sa=screenAng();
  if(sa===90) {const t=lx;lx=-ly;ly=t}
  else if(sa===270){const t=lx;lx=ly;ly=-t}
  else if(sa===180){lx=-lx;ly=-ly}
  return{
    x: lx/Math.tan(HFOV/2)*(W/2)+W/2,
    y:-ly/Math.tan(vfov/2)*(H/2)+H/2
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CANVAS RESIZE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resize(){
  W=canvas.width =window.innerWidth;
  H=canvas.height=window.innerHeight;
  if(!locked) initCorners(false);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CORNERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initCorners(force=true){
  if(!force && corners.length===4) return;
  const pw=W*0.55, ph=pw;  // square default
  const cx=W/2, cy=H*0.42;
  corners=[
    {x:cx-pw/2, y:cy-ph/2},  // TL
    {x:cx+pw/2, y:cy-ph/2},  // TR
    {x:cx+pw/2, y:cy+ph/2},  // BR
    {x:cx-pw/2, y:cy+ph/2},  // BL
  ];
}

function resetCorners(){
  locked=null;
  imgFlip=false;
  alphaOff=null;
  initCorners(true);
  setEditMode();
  setHint('Drag sudut berwarna Â· Drag tengah untuk geser semua');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOCK / UNLOCK
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleLock(){
  if(locked) unlockImage();
  else lockImage();
}

function lockImage(){
  // Store world-space direction for each corner
  locked = corners.map(c=>px2world(c.x,c.y));
  setLockedMode();
  setHint('âœ… Dikunci! Gerakkan HP â€” foto tetap stay');
  setTimeout(()=>setHint(''),3500);
}

function unlockImage(){
  // Reconstruct screen corners from current projection
  if(locked){
    const proj=locked.map(wd=>world2px(wd));
    if(proj.every(p=>p!==null)){
      corners=proj.map(p=>({x:p.x,y:p.y}));
    }
  }
  locked=null;
  setEditMode();
  setHint('Edit mode â€” drag sudut untuk atur ulang');
  setTimeout(()=>setHint(''),2500);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PERSPECTIVE WARP DRAW
   Uses fine triangle mesh for correct perspective
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function drawWarped(cors){
  if(!img.complete||!img.naturalWidth) return;
  const iw=img.naturalWidth, ih=img.naturalHeight;

  function quad(u,v){
    // bilinear interpolation of 4 corners
    const fl=imgFlip;
    const pu=fl?1-u:u;
    const t={x:cors[0].x+(cors[1].x-cors[0].x)*pu, y:cors[0].y+(cors[1].y-cors[0].y)*pu};
    const b={x:cors[3].x+(cors[2].x-cors[3].x)*pu, y:cors[3].y+(cors[2].y-cors[3].y)*pu};
    return{x:t.x+(b.x-t.x)*v, y:t.y+(b.y-t.y)*v};
  }

  for(let i=0;i<MESH;i++){
    for(let j=0;j<MESH;j++){
      const u0=i/MESH, u1=(i+1)/MESH;
      const v0=j/MESH, v1=(j+1)/MESH;
      const p00=quad(u0,v0), p10=quad(u1,v0);
      const p11=quad(u1,v1), p01=quad(u0,v1);
      // src texels (always non-flipped, flip handled by quad())
      const s00={x:u0*iw,y:v0*ih}, s10={x:u1*iw,y:v0*ih};
      const s11={x:u1*iw,y:v1*ih}, s01={x:u0*iw,y:v1*ih};
      triDraw(s00,s10,s11, p00,p10,p11);
      triDraw(s00,s11,s01, p00,p11,p01);
    }
  }
}

function triDraw(s0,s1,s2, d0,d1,d2){
  const det=(s1.x-s0.x)*(s2.y-s0.y)-(s2.x-s0.x)*(s1.y-s0.y);
  if(Math.abs(det)<0.4) return;
  const id=1/det;
  const a=((d1.x-d0.x)*(s2.y-s0.y)-(d2.x-d0.x)*(s1.y-s0.y))*id;
  const b=((d2.x-d0.x)*(s1.x-s0.x)-(d1.x-d0.x)*(s2.x-s0.x))*id;
  const c=d0.x-a*s0.x-b*s0.y;
  const d=((d1.y-d0.y)*(s2.y-s0.y)-(d2.y-d0.y)*(s1.y-s0.y))*id;
  const e=((d2.y-d0.y)*(s1.x-s0.x)-(d1.y-d0.y)*(s2.x-s0.x))*id;
  const f=d0.y-d*s0.x-e*s0.y;
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(d0.x,d0.y);ctx.lineTo(d1.x,d1.y);ctx.lineTo(d2.x,d2.y);
  ctx.closePath();ctx.clip();
  ctx.transform(a,d,b,e,c,f);
  ctx.shadowColor='rgba(0,0,0,.5)';
  ctx.shadowBlur=20;ctx.shadowOffsetX=6;ctx.shadowOffsetY=8;
  ctx.drawImage(img,0,0);
  ctx.restore();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   OVERLAY: outline + XYZ axes + corner handles
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function drawOverlay(cors, isLocked){
  // Quad outline
  ctx.save();
  ctx.strokeStyle=isLocked?'rgba(60,240,140,.5)':'rgba(180,140,255,.6)';
  ctx.lineWidth=isLocked?1.5:2;
  ctx.setLineDash(isLocked?[5,5]:[]);
  ctx.beginPath();
  ctx.moveTo(cors[0].x,cors[0].y);
  cors.slice(1).forEach(c=>ctx.lineTo(c.x,c.y));
  ctx.closePath();ctx.stroke();
  ctx.restore();

  // XYZ axes from center
  const cx=(cors[0].x+cors[1].x+cors[2].x+cors[3].x)/4;
  const cy=(cors[0].y+cors[1].y+cors[2].y+cors[3].y)/4;
  const xvx=(cors[1].x-cors[0].x+cors[2].x-cors[3].x)/2;
  const xvy=(cors[1].y-cors[0].y+cors[2].y-cors[3].y)/2;
  const yvx=(cors[3].x-cors[0].x+cors[2].x-cors[1].x)/2;
  const yvy=(cors[3].y-cors[0].y+cors[2].y-cors[1].y)/2;
  const xl=Math.hypot(xvx,xvy)||1, yl=Math.hypot(yvx,yvy)||1;
  const S=46;
  drawArrow(cx,cy,xvx/xl*S,xvy/xl*S,'#ff4444','X');
  drawArrow(cx,cy,yvx/yl*S,yvy/yl*S,'#44ff88','Y');
  drawArrow(cx,cy,-(xvx/xl+yvx/yl)*S*0.5,-(xvy/xl+yvy/yl)*S*0.5,'#4499ff','Z');

  // Corner handles (only in edit mode)
  if(!isLocked){
    cors.forEach((c,i)=>{
      // Outer ring (touch area indicator)
      ctx.beginPath(); ctx.arc(c.x,c.y,26,0,Math.PI*2);
      ctx.fillStyle='rgba(0,0,0,.38)'; ctx.fill();

      // Colored filled circle
      ctx.beginPath(); ctx.arc(c.x,c.y,16,0,Math.PI*2);
      ctx.fillStyle=COLORS[i];
      ctx.shadowColor=COLORS[i]; ctx.shadowBlur=16;
      ctx.fill(); ctx.shadowBlur=0;

      // White ring
      ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=2.5; ctx.stroke();

      // Label
      ctx.fillStyle='#fff'; ctx.font='bold 9px monospace';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(LABELS[i],c.x,c.y);
    });
  }
}

function drawArrow(ox,oy,dx,dy,col,lbl){
  const len=Math.hypot(dx,dy); if(len<4)return;
  const ang=Math.atan2(dy,dx);
  ctx.save();
  ctx.strokeStyle=col; ctx.fillStyle=col;
  ctx.lineWidth=2.5; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(ox+dx,oy+dy); ctx.stroke();
  const al=11,aw=0.44;
  ctx.beginPath();
  ctx.moveTo(ox+dx,oy+dy);
  ctx.lineTo(ox+dx-al*Math.cos(ang-aw),oy+dy-al*Math.sin(ang-aw));
  ctx.lineTo(ox+dx-al*Math.cos(ang+aw),oy+dy-al*Math.sin(ang+aw));
  ctx.closePath(); ctx.fill();
  const lx=ox+dx+15*Math.cos(ang), ly=oy+dy+15*Math.sin(ang);
  ctx.font='bold 13px monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(lx-8,ly-8,16,16);
  ctx.fillStyle=col; ctx.fillText(lbl,lx,ly);
  ctx.restore();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MAIN RENDER LOOP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loop(){
  ctx.clearRect(0,0,W,H);

  let cors;
  if(locked){
    const proj=locked.map(wd=>world2px(wd));
    if(proj.some(p=>p===null)){
      drawBehindMsg(); animId=requestAnimationFrame(loop); return;
    }
    cors=proj;
  } else {
    cors=corners;
  }

  drawWarped(cors);
  drawOverlay(cors,!!locked);
  animId=requestAnimationFrame(loop);
}

function drawBehindMsg(){
  ctx.save();
  ctx.fillStyle='rgba(255,200,80,.9)';
  ctx.font='bold 13px sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('â†© Foto di belakang kamu â€” putar HP',W/2,H/2);
  ctx.restore();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   POINTER INPUT  (unified touch + mouse)
   Key: e.preventDefault() is called IMMEDIATELY
   in touchstart â€” this blocks all long-press popups
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getEventPos(e){
  // Returns {x,y} from touch or mouse event
  const src=e.touches?e.touches[0]:e;
  return{x:src.clientX, y:src.clientY};
}

function nearestCorner(x,y){
  let best=-1, bd=9999;
  corners.forEach((c,i)=>{
    const d=Math.hypot(x-c.x,y-c.y);
    if(d<bd){bd=d;best=i}
  });
  return bd<HIT_R*2 ? best : -1;
}

function onPointerDown(e){
  // â† CRITICAL: prevent context menu / long-press popup immediately
  e.preventDefault();
  e.stopPropagation();
  if(locked) return;
  const p=getEventPos(e);
  const idx=nearestCorner(p.x,p.y);
  if(idx>=0){
    activeIdx=idx;
  } else {
    // drag entire image
    activeIdx=4;
    moveStart={x:p.x,y:p.y};
    cornersSnap=corners.map(c=>({...c}));
  }
}

function onPointerMove(e){
  e.preventDefault();
  e.stopPropagation();
  if(locked||activeIdx===-1) return;
  const p=getEventPos(e);
  if(activeIdx>=0&&activeIdx<4){
    corners[activeIdx]={x:p.x,y:p.y};
  } else if(activeIdx===4&&moveStart){
    const dx=p.x-moveStart.x, dy=p.y-moveStart.y;
    corners=cornersSnap.map(c=>({x:c.x+dx,y:c.y+dy}));
  }
}

function onPointerUp(e){
  e.preventDefault();
  activeIdx=-1;
  moveStart=null;
  cornersSnap=null;
}

// Register on canvas with {passive:false} to enable preventDefault in touchstart
function bindCanvasEvents(){
  // Touch
  canvas.addEventListener('touchstart',  onPointerDown, {passive:false, capture:true});
  canvas.addEventListener('touchmove',   onPointerMove, {passive:false, capture:true});
  canvas.addEventListener('touchend',    onPointerUp,   {passive:false, capture:true});
  canvas.addEventListener('touchcancel', onPointerUp,   {passive:false, capture:true});
  // Mouse (desktop)
  canvas.addEventListener('mousedown', onPointerDown);
  canvas.addEventListener('mousemove', onPointerMove);
  canvas.addEventListener('mouseup',   onPointerUp);
  // Block context menu on canvas specifically
  canvas.addEventListener('contextmenu', e=>{e.preventDefault();e.stopPropagation();return false;}, true);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   GYROSCOPE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onOri(e){
  if(e.beta===null)return;
  const rawA=e.alpha||0;
  if(alphaOff===null) alphaOff=rawA;
  oA=((rawA-alphaOff+360)%360)*DEG;
  oB=e.beta*DEG;
  oG=e.gamma*DEG;
  hasOri=true;
}

function setupOri(){
  if(typeof DeviceOrientationEvent!=='undefined' &&
     typeof DeviceOrientationEvent.requestPermission==='function'){
    document.getElementById('permOvl').style.display='flex';
  } else {
    window.addEventListener('deviceorientation',onOri,true);
    // Desktop mouse simulation
    if(!('ontouchstart' in window)){
      hasOri=true;
      document.addEventListener('mousemove',me=>{
        if(activeIdx!==-1) return; // don't interfere with dragging
        oA=((me.clientX/W)-0.5)*1.8;
        oB=Math.PI/2+((me.clientY/H)-0.5)*1.1;
        oG=0;
      });
      setHint('ğŸ–¥ï¸ Desktop: gerakkan mouse untuk preview 3D');
    }
  }
}

async function reqPerm(){
  document.getElementById('permOvl').style.display='none';
  try{
    const r=await DeviceOrientationEvent.requestPermission();
    if(r==='granted') window.addEventListener('deviceorientation',onOri,true);
    else setHint('âš ï¸ Izin ditolak â€” 3D tracking tidak aktif');
  }catch{window.addEventListener('deviceorientation',onOri,true)}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UI HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setEditMode(){
  document.getElementById('badge').textContent='âœï¸ Edit â€” Drag 4 Sudut';
  document.getElementById('badge').className='edit';
  document.getElementById('lockBtn').textContent='ğŸ“Œ Kunci 3D';
  document.getElementById('lockBtn').className='abtn green';
}

function setLockedMode(){
  document.getElementById('badge').textContent='ğŸ”’ Terkunci â€” 3D Tracking Aktif';
  document.getElementById('badge').className='locked';
  document.getElementById('lockBtn').textContent='ğŸ”“ Edit Ulang';
  document.getElementById('lockBtn').className='abtn blue';
}

function setHint(msg){
  const el=document.getElementById('hint');
  el.textContent=msg;
  el.style.opacity=msg?'1':'0';
}

function doFlip(){
  imgFlip=!imgFlip;
}

async function saveSnap(){
  const sc=document.createElement('canvas');
  sc.width=W; sc.height=H;
  const sx=sc.getContext('2d');
  sx.drawImage(document.getElementById('vid'),0,0,W,H);
  sx.drawImage(canvas,0,0);
  const a=document.createElement('a');
  a.download='ar-wall-3d.jpg';
  a.href=sc.toDataURL('image/jpeg',.93);
  a.click();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FILE PICK
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onFile(e){
  const f=e.target.files[0]; if(!f)return;
  const url=URL.createObjectURL(f);
  img.src=url;
  const pv=document.getElementById('prevImg');
  pv.src=url; pv.style.display='block';
  document.getElementById('ph').style.display='none';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   START / STOP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function startAR(){
  if(!img.src||img.src===location.href) img.src=buildDefaultImg();

  try{
    camStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},
      audio:false
    });
  }catch(err){
    alert('Kamera gagal diakses:\n'+err.message); return;
  }

  const vid=document.getElementById('vid');
  vid.srcObject=camStream;
  await vid.play();

  document.getElementById('splash').style.display='none';
  document.getElementById('ar').style.display='block';

  canvas=document.getElementById('cv');
  ctx=canvas.getContext('2d');

  W=canvas.width =window.innerWidth;
  H=canvas.height=window.innerHeight;
  initCorners(true);
  bindCanvasEvents();
  setEditMode();
  setHint('Drag sudut berwarna Â· Drag tengah untuk geser semua');

  window.addEventListener('resize',resize);
  if(screen.orientation) screen.orientation.addEventListener('change',()=>setTimeout(resize,300));

  setupOri();
  animId=requestAnimationFrame(loop);
}

function stopAR(){
  cancelAnimationFrame(animId); animId=null;
  if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
  window.removeEventListener('deviceorientation',onOri,true);
  window.removeEventListener('resize',resize);
  document.getElementById('ar').style.display='none';
  document.getElementById('splash').style.display='flex';
  locked=null; hasOri=false; alphaOff=null; imgFlip=false;
  activeIdx=-1; moveStart=null; cornersSnap=null;
  setHint('Drag sudut berwarna Â· Drag tengah untuk geser semua');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DEFAULT IMAGE (square gradient)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildDefaultImg(){
  const c=document.createElement('canvas'); c.width=c.height=600;
  const x=c.getContext('2d');
  const g=x.createLinearGradient(0,0,600,600);
  g.addColorStop(0,'#2211cc'); g.addColorStop(.5,'#aa22dd'); g.addColorStop(1,'#ff5522');
  x.fillStyle=g; x.fillRect(0,0,600,600);
  x.strokeStyle='rgba(255,255,255,.08)'; x.lineWidth=1;
  for(let i=0;i<600;i+=40){
    x.beginPath();x.moveTo(i,0);x.lineTo(i,600);x.stroke();
    x.beginPath();x.moveTo(0,i);x.lineTo(600,i);x.stroke();
  }
  x.strokeStyle='rgba(255,255,255,.3)'; x.lineWidth=6; x.strokeRect(18,18,564,564);
  x.fillStyle='rgba(255,255,255,.9)'; x.font='bold 68px Arial'; x.textAlign='center';
  x.fillText('AR IMAGE',300,280);
  x.font='22px Arial'; x.fillStyle='rgba(255,255,255,.5)';
  x.fillText('Pilih foto dari splash',300,350);
  return c.toDataURL();
}
</script>
</body>
</html>
