<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>AR Wall 3D</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
body{background:#06060f;font-family:'Segoe UI',system-ui,sans-serif;color:#fff;overflow:hidden;width:100vw;height:100dvh}

#splash{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100dvh;padding:28px;gap:18px;background:radial-gradient(ellipse 80% 50% at 50% 0%,#180a40,#06060f 70%)}
.slogo{font-size:52px;filter:drop-shadow(0 0 26px #9955ffaa)}
h1{font-size:25px;font-weight:900;letter-spacing:-0.8px;text-align:center;background:linear-gradient(130deg,#bb88ff 20%,#ff66cc 80%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.ssub{font-size:13px;color:#666;text-align:center;line-height:1.65;max-width:320px}
.card{background:#0e0e1c;border:1px solid #1e1e38;border-radius:20px;padding:16px;width:100%;max-width:350px}
.clbl{font-size:10px;color:#555;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.pbox{width:100%;aspect-ratio:1/1;border-radius:12px;overflow:hidden;background:#0a0a18;border:2px dashed #1e1e38;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:border-color .2s}
.pbox:active{border-color:#9955ff}
.pbox img{width:100%;height:100%;object-fit:cover;display:none}
.ph{display:flex;flex-direction:column;align-items:center;gap:6px;color:#333;font-size:11px}
.ph .ei{font-size:28px}
input[type=file]{display:none}
.sbtn{background:linear-gradient(135deg,#4422ee,#aa44dd);border:none;color:#fff;border-radius:16px;padding:16px;font-size:16px;font-weight:800;cursor:pointer;width:100%;max-width:350px;box-shadow:0 6px 28px #6622ee44;transition:transform .1s,opacity .2s}
.sbtn:active{transform:scale(.97);opacity:.88}

#ar{display:none;position:fixed;inset:0;z-index:100}
#vid{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1}
#cv{position:absolute;inset:0;width:100%;height:100%;z-index:2;touch-action:none}
#topbar{position:absolute;top:0;left:0;right:0;z-index:10;padding:16px 18px 12px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(to bottom,rgba(0,0,0,.75),transparent)}
.tbtitle{font-size:14px;font-weight:700}
.tbclose{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.14);color:#fff;border-radius:50px;padding:7px 16px;font-size:12px;cursor:pointer}
#badge{position:absolute;top:70px;left:50%;transform:translateX(-50%);z-index:10;padding:7px 18px;border-radius:50px;font-size:12px;font-weight:700;background:rgba(255,170,0,.18);border:1px solid rgba(255,200,0,.35);color:#ffd060;backdrop-filter:blur(12px);white-space:nowrap}
#panel{position:absolute;bottom:0;left:0;right:0;z-index:10;padding:10px 12px 28px;background:linear-gradient(to top,rgba(0,0,0,.88) 70%,transparent)}
.btnrow{display:flex;gap:8px}
.abtn{background:rgba(255,255,255,.09);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:50px;padding:11px 13px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;flex:1;text-align:center}
.abtn.red{background:rgba(180,20,20,.3);border-color:rgba(220,50,50,.3)}
</style>
</head>
<body>
<div id="splash">
  <div class="slogo">üñºÔ∏è</div>
  <h1>AR Wall 3D</h1>
  <p class="ssub">Tekan Mulai AR, lalu geser 4 titik sudut untuk menempelkan foto persegi ke sudut dinding.</p>
  <div class="card">
    <div class="clbl">Pilih Foto (Persegi)</div>
    <div class="pbox" onclick="document.getElementById('fi').click()">
      <div class="ph" id="ph"><span class="ei">üìÇ</span>Ketuk untuk pilih foto</div>
      <img id="prevImg"/>
    </div>
    <input type="file" id="fi" accept="image/*" onchange="onFile(event)"/>
  </div>
  <button class="sbtn" onclick="startAR()">üì∑ Mulai AR</button>
</div>

<div id="ar">
  <video id="vid" autoplay playsinline muted></video>
  <canvas id="cv"></canvas>
  <div id="topbar">
    <div class="tbtitle">üñºÔ∏è AR Wall 3D</div>
    <div class="tbclose" onclick="stopAR()">‚úï Keluar</div>
  </div>
  <div id="badge">Geser 4 titik sudut untuk atur foto</div>
  <div id="panel">
    <div class="btnrow">
      <div class="abtn" onclick="resetCorners()">‚Ü∫ Reset Titik</div>
      <div class="abtn" onclick="doFlip()">‚áÑ Flip</div>
      <div class="abtn" onclick="saveSnap()">üíæ Simpan</div>
      <div class="abtn red" onclick="stopAR()">‚úï</div>
    </div>
  </div>
</div>

<script>
let canvas, ctx, W, H;
let camStream = null, animId = null;
const img = new Image();
let imgFlip = false;
let corners = [];
let dragIndex = -1;
let dragBound = false;
const MESH = 16;

function onFile(e){
  const f=e.target.files[0]; if(!f)return;
  const url=URL.createObjectURL(f);
  img.src=url;
  document.getElementById('prevImg').src=url;
  document.getElementById('prevImg').style.display='block';
  document.getElementById('ph').style.display='none';
}

function ensureImageReady(){
  return new Promise(resolve=>{
    if(img.complete&&img.naturalWidth)return resolve();
    const done=()=>resolve();
    img.addEventListener('load',done,{once:true});
    img.addEventListener('error',done,{once:true});
  });
}

function resetCorners(){
  const s=Math.min(W,H)*0.56;
  const cx=W/2, cy=H/2;
  corners=[
    {x:cx-s/2,y:cy-s/2}, // TL
    {x:cx+s/2,y:cy-s/2}, // TR
    {x:cx+s/2,y:cy+s/2}, // BR
    {x:cx-s/2,y:cy+s/2}  // BL
  ];
}

function clampPoint(p){
  p.x=Math.max(0,Math.min(W,p.x));
  p.y=Math.max(0,Math.min(H,p.y));
}

function getPointFromEvent(e){
  const r=canvas.getBoundingClientRect();
  return {x:e.clientX-r.left,y:e.clientY-r.top};
}

function nearestCorner(p){
  let best=-1, d=1e9;
  for(let i=0;i<corners.length;i++){
    const dx=corners[i].x-p.x, dy=corners[i].y-p.y;
    const dd=dx*dx+dy*dy;
    if(dd<d){d=dd;best=i}
  }
  return d<=45*45?best:-1;
}

function bindDrag(){
  if(dragBound)return;
  dragBound=true;
  canvas.addEventListener('pointerdown',e=>{
    const p=getPointFromEvent(e);
    const i=nearestCorner(p);
    if(i===-1)return;
    dragIndex=i;
    canvas.setPointerCapture(e.pointerId);
  });
  canvas.addEventListener('pointermove',e=>{
    if(dragIndex===-1)return;
    const p=getPointFromEvent(e);
    corners[dragIndex].x=p.x;
    corners[dragIndex].y=p.y;
    clampPoint(corners[dragIndex]);
  });
  const up=()=>{dragIndex=-1};
  canvas.addEventListener('pointerup',up);
  canvas.addEventListener('pointercancel',up);
}

function drawWarp(pts){
  if(!img.complete||!img.naturalWidth)return;
  const iw=img.naturalWidth, ih=img.naturalHeight;
  function qp(u,v){
    const su=imgFlip?1-u:u;
    const t={x:pts[0].x+(pts[1].x-pts[0].x)*su,y:pts[0].y+(pts[1].y-pts[0].y)*su};
    const b={x:pts[3].x+(pts[2].x-pts[3].x)*su,y:pts[3].y+(pts[2].y-pts[3].y)*su};
    return{x:t.x+(b.x-t.x)*v,y:t.y+(b.y-t.y)*v};
  }
  for(let i=0;i<MESH;i++)for(let j=0;j<MESH;j++){
    const u0=i/MESH,u1=(i+1)/MESH,v0=j/MESH,v1=(j+1)/MESH;
    const p00=qp(u0,v0),p10=qp(u1,v0),p11=qp(u1,v1),p01=qp(u0,v1);
    const s00={x:u0*iw,y:v0*ih},s10={x:u1*iw,y:v0*ih},s11={x:u1*iw,y:v1*ih},s01={x:u0*iw,y:v1*ih};
    triMap(s00,s10,s11,p00,p10,p11);
    triMap(s00,s11,s01,p00,p11,p01);
  }
}

function triMap(s0,s1,s2,d0,d1,d2){
  const det=(s1.x-s0.x)*(s2.y-s0.y)-(s2.x-s0.x)*(s1.y-s0.y);
  if(Math.abs(det)<0.5)return;
  ctx.save();
  ctx.beginPath();ctx.moveTo(d0.x,d0.y);ctx.lineTo(d1.x,d1.y);ctx.lineTo(d2.x,d2.y);ctx.closePath();ctx.clip();
  const id=1/det;
  const a=((d1.x-d0.x)*(s2.y-s0.y)-(d2.x-d0.x)*(s1.y-s0.y))*id;
  const b=((d2.x-d0.x)*(s1.x-s0.x)-(d1.x-d0.x)*(s2.x-s0.x))*id;
  const c=d0.x-a*s0.x-b*s0.y;
  const d=((d1.y-d0.y)*(s2.y-s0.y)-(d2.y-d0.y)*(s1.y-s0.y))*id;
  const e=((d2.y-d0.y)*(s1.x-s0.x)-(d1.y-d0.y)*(s2.x-s0.x))*id;
  const f=d0.y-d*s0.x-e*s0.y;
  ctx.transform(a,d,b,e,c,f);
  ctx.drawImage(img,0,0);
  ctx.restore();
}

function drawHandles(pts){
  ctx.save();
  ctx.strokeStyle='rgba(180,140,255,.9)';
  ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);
  [1,2,3,0].forEach(i=>ctx.lineTo(pts[i].x,pts[i].y));
  ctx.stroke();
  for(let i=0;i<4;i++){
    const p=pts[i];
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.beginPath();ctx.arc(p.x,p.y,8,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.45)';
    ctx.lineWidth=2;ctx.stroke();
  }
  ctx.restore();
}

function loop(){
  ctx.clearRect(0,0,W,H);
  if(corners.length===4){
    drawWarp(corners);
    drawHandles(corners);
  }
  animId=requestAnimationFrame(loop);
}

function resize(){
  const oldW=W||window.innerWidth, oldH=H||window.innerHeight;
  W=canvas.width=window.innerWidth;
  H=canvas.height=window.innerHeight;
  if(corners.length===4){
    const sx=W/oldW, sy=H/oldH;
    corners.forEach(p=>{p.x*=sx;p.y*=sy;clampPoint(p)});
  }
}

function doFlip(){imgFlip=!imgFlip}

async function saveSnap(){
  const sc=document.createElement('canvas');sc.width=W;sc.height=H;
  const sx=sc.getContext('2d');
  sx.drawImage(document.getElementById('vid'),0,0,W,H);
  sx.drawImage(canvas,0,0);
  const a=document.createElement('a');a.download='ar-wall-3d.jpg';
  a.href=sc.toDataURL('image/jpeg',.96);a.click();
}

async function startAR(){
  if(!img.src||img.src===window.location.href)img.src=buildDefaultImg();
  await ensureImageReady();
  try{
    camStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},audio:false});
  }catch(e){alert('Kamera gagal:\n'+e.message);return}

  const vid=document.getElementById('vid');
  vid.srcObject=camStream;await vid.play();
  document.getElementById('splash').style.display='none';
  document.getElementById('ar').style.display='block';
  canvas=document.getElementById('cv');ctx=canvas.getContext('2d');
  resize();
  resetCorners();
  bindDrag();
  window.addEventListener('resize',resize);
  animId=requestAnimationFrame(loop);
}

function stopAR(){
  cancelAnimationFrame(animId);animId=null;
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null}
  window.removeEventListener('resize',resize);
  document.getElementById('ar').style.display='none';
  document.getElementById('splash').style.display='flex';
  dragIndex=-1;
}

function buildDefaultImg(){
  const c=document.createElement('canvas');c.width=1200;c.height=1200;
  const x=c.getContext('2d');
  const g=x.createLinearGradient(0,0,1200,1200);
  g.addColorStop(0,'#4a1fb8');g.addColorStop(1,'#b53fd5');
  x.fillStyle=g;x.fillRect(0,0,1200,1200);
  x.fillStyle='rgba(255,255,255,.9)';
  x.font='bold 92px Arial';x.textAlign='center';
  x.fillText('PILIH FOTO',600,620);
  return c.toDataURL('image/jpeg',1);
}
</script>
</body>
</html>
