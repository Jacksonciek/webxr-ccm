<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>AR Wall 3D</title>
<style>
:root{--bg:#06060e;--sur:#0f0f1c;--brd:#1e1e35;--acc:#7c5cff;--acc2:#e040fb;--tx:#f0f0ff;--mt:#555570;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);font-family:'Helvetica Neue',Helvetica,sans-serif;color:var(--tx);overflow:hidden;width:100vw;height:100dvh;touch-action:none;}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;gap:22px;background:radial-gradient(ellipse 80% 60% at 50% 0%,#1a0a3e,var(--bg) 70%);}
.s-icon{width:72px;height:72px;background:linear-gradient(135deg,var(--acc),var(--acc2));border-radius:22px;display:flex;align-items:center;justify-content:center;font-size:34px;box-shadow:0 0 40px #7c5cff44;}
.s-title{font-size:26px;font-weight:800;letter-spacing:-0.8px;text-align:center;background:linear-gradient(135deg,#b09fff,#f080ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.s-sub{font-size:13px;color:var(--mt);text-align:center;line-height:1.7;max-width:300px;}
.card{background:var(--sur);border:1px solid var(--brd);border-radius:20px;padding:18px;width:100%;max-width:360px;}
.clbl{font-size:10px;color:var(--mt);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;}
.prev-box{width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;background:#0a0a18;border:2px dashed var(--brd);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:border-color .2s;position:relative;}
.prev-box:active{border-color:var(--acc);}
.prev-box img{width:100%;height:100%;object-fit:cover;display:none;}
.ph{display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--mt);font-size:12px;}
input[type=file]{display:none;}
.sbtn{width:100%;max-width:360px;background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;color:#fff;border-radius:16px;padding:17px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 28px #7c5cff40;transition:transform .1s,opacity .2s;}
.sbtn:active{transform:scale(.97);opacity:.88;}
.chips{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.chip{background:var(--sur);border:1px solid var(--brd);border-radius:50px;padding:5px 13px;font-size:11px;color:var(--mt);}
.chip b{color:#88ffcc;margin-right:3px;}

/* AR WORLD */
#aw{display:none;position:fixed;inset:0;z-index:10;}
#cam{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;}
#tc{position:absolute;inset:0;width:100%;height:100%;z-index:2;pointer-events:none;}
#ui{position:absolute;inset:0;z-index:5;pointer-events:none;}

/* Crosshair */
#ch{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:56px;height:56px;pointer-events:none;transition:opacity .3s;}
#ch::before,#ch::after{content:'';position:absolute;background:rgba(180,160,255,.85);box-shadow:0 0 8px var(--acc);}
#ch::before{width:2px;height:100%;left:calc(50% - 1px);}
#ch::after{width:100%;height:2px;top:calc(50% - 1px);}
.cc{position:absolute;width:10px;height:10px;border-color:rgba(180,160,255,.85);border-style:solid;box-shadow:0 0 6px var(--acc);}
.tl{top:0;left:0;border-width:2px 0 0 2px;}
.tr{top:0;right:0;border-width:2px 2px 0 0;}
.bl{bottom:0;left:0;border-width:0 0 2px 2px;}
.br{bottom:0;right:0;border-width:0 2px 2px 0;}

/* Top bar */
#tb{position:absolute;top:0;left:0;right:0;padding:18px 18px 14px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(to bottom,rgba(6,6,14,.75),transparent);pointer-events:all;}
.tbt{font-size:14px;font-weight:700;letter-spacing:.5px;}
.tbb{font-size:11px;font-weight:600;background:rgba(124,92,255,.3);border:1px solid rgba(124,92,255,.5);border-radius:50px;padding:4px 12px;color:#c0b0ff;}
.tbc{background:rgba(255,255,255,.1);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:50px;padding:6px 15px;font-size:13px;cursor:pointer;}

/* Status */
#sh{position:absolute;top:76px;left:50%;transform:translateX(-50%);background:rgba(6,6,14,.7);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:50px;padding:8px 20px;font-size:12px;color:#bbb;white-space:nowrap;pointer-events:none;transition:all .4s;}
#pb{display:none;position:absolute;top:76px;left:50%;transform:translateX(-50%);background:rgba(40,200,100,.2);backdrop-filter:blur(10px);border:1px solid rgba(60,220,120,.35);border-radius:50px;padding:8px 20px;font-size:12px;color:#6fffa0;white-space:nowrap;pointer-events:none;animation:fid .4s ease;}
@keyframes fid{from{opacity:0;transform:translateX(-50%) translateY(-10px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

/* Bottom */
#bp{position:absolute;bottom:0;left:0;right:0;padding:16px 18px 40px;background:linear-gradient(to top,rgba(6,6,14,.85),transparent);display:flex;flex-direction:column;gap:12px;align-items:center;pointer-events:all;}
.sr{display:flex;align-items:center;gap:10px;background:rgba(15,15,28,.7);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:50px;padding:9px 18px;width:100%;max-width:360px;}
.sr label{font-size:11px;color:#888;min-width:48px;}
input[type=range]{flex:1;-webkit-appearance:none;height:3px;background:rgba(255,255,255,.2);border-radius:10px;outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:0 0 8px #7c5cff88;cursor:pointer;}
.br2{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.ab{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:50px;padding:11px 20px;font-size:13px;font-weight:600;cursor:pointer;transition:background .15s;white-space:nowrap;}
.ab:active{background:rgba(255,255,255,.25);}
.ab.pl{background:linear-gradient(135deg,var(--acc),var(--acc2));border-color:transparent;font-size:14px;box-shadow:0 4px 20px #7c5cff50;padding:13px 28px;}
.ab.dn{background:rgba(200,40,40,.35);border-color:rgba(220,60,60,.4);}

/* Gyro prompt */
#gp{display:none;position:fixed;inset:0;z-index:300;background:rgba(6,6,14,.93);backdrop-filter:blur(16px);flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:32px;}
.gi{font-size:48px;}.gt{font-size:20px;font-weight:700;text-align:center;}.gs{font-size:13px;color:var(--mt);text-align:center;line-height:1.6;max-width:280px;}
.gb{background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;color:#fff;border-radius:14px;padding:14px 32px;font-size:15px;font-weight:700;cursor:pointer;}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="s-icon">üñºÔ∏è</div>
  <div class="s-title">AR Wall 3D</div>
  <div class="s-sub">Tempel gambar ke dinding ‚Äî <b>gambar stay di tempat</b> saat HP digerakkan ke mana saja</div>
  <div class="card">
    <div class="clbl">Pilih Gambar</div>
    <div class="prev-box" onclick="document.getElementById('fi').click()">
      <div class="ph" id="ph"><span style="font-size:32px">üóÇÔ∏è</span>Ketuk untuk pilih foto</div>
      <img id="pi"/>
    </div>
    <input type="file" id="fi" accept="image/*" onchange="onPick(event)"/>
  </div>
  <button class="sbtn" onclick="startAR()">üì∑ Buka Kamera AR</button>
  <div class="chips">
    <div class="chip"><b>‚úì</b>iOS Safari</div>
    <div class="chip"><b>‚úì</b>Android Chrome</div>
    <div class="chip"><b>‚úì</b>3D Stay di Tempat</div>
  </div>
</div>

<!-- GYRO PERMISSION (iOS) -->
<div id="gp">
  <div class="gi">üì±</div>
  <div class="gt">Izin Sensor Gerak</div>
  <div class="gs">iOS butuh izin giroskop agar gambar bisa stay di tempat saat HP digerakkan.</div>
  <button class="gb" onclick="requestGyro()">Izinkan Sensor ‚Üí</button>
</div>

<!-- AR WORLD -->
<div id="aw">
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="tc"></canvas>
  <div id="ui">
    <div id="ch">
      <div class="cc tl"></div><div class="cc tr"></div>
      <div class="cc bl"></div><div class="cc br"></div>
    </div>
    <div id="tb">
      <div class="tbt">üñºÔ∏è AR Wall 3D</div>
      <div class="tbb" id="sbadge">PREVIEW</div>
      <div class="tbc" onclick="stopAR()">‚úï</div>
    </div>
    <div id="sh">Arahkan ke dinding ‚Üí tekan Tempel di Sini</div>
    <div id="pb">üìå Gambar ditempel di dinding!</div>
    <div id="bp">
      <div class="sr"><label>üìê Ukuran</label><input type="range" id="slsz" min="5" max="95" value="35" oninput="onSlSz(this.value)"/></div>
      <div class="sr"><label>üîÑ Rotasi</label><input type="range" id="slrt" min="0" max="360" value="0" oninput="onSlRt(this.value)"/></div>
      <div class="br2">
        <div class="ab" onclick="doFlip()">‚áÑ Flip</div>
        <div class="ab pl" id="plbtn" onclick="placeImage()">üìå Tempel di Sini</div>
        <div class="ab" id="undobtn" style="display:none" onclick="undoPlace()">‚Ü© Lepas</div>
      </div>
      <div class="br2">
        <div class="ab" onclick="savePhoto()">üíæ Simpan</div>
        <div class="ab dn" onclick="stopAR()">‚úï Keluar</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let renderer,scene,camera,imgMesh;
let camStream,animId;
let isPlaced=false,imgFlipped=false;
let imgScale=0.7,imgRotOff=0;
let devA=0,devB=0,devG=0,screenOri=0;
let gyroOk=false;
const limg=new Image();
let userSrc=null;
const _zee=new THREE.Vector3(0,0,1);
const _euler=new THREE.Euler();
const _q0=new THREE.Quaternion();
const _q1=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));

// ‚îÄ‚îÄ PICK ‚îÄ‚îÄ
function onPick(e){
  const f=e.target.files[0]; if(!f) return;
  userSrc=URL.createObjectURL(f); limg.src=userSrc;
  const pi=document.getElementById('pi');
  pi.src=userSrc; pi.style.display='block';
  document.getElementById('ph').style.display='none';
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
async function startAR(){
  try{
    camStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},audio:false
    });
  }catch(err){alert('Kamera error:\n'+err.message);return;}
  const v=document.getElementById('cam'); v.srcObject=camStream; await v.play();

  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    document.getElementById('gp').style.display='flex'; return;
  }
  window.addEventListener('deviceorientation',onDO,true);
  window.addEventListener('orientationchange',()=>{screenOri=window.orientation||0;});
  launch();
}

async function requestGyro(){
  document.getElementById('gp').style.display='none';
  try{
    const r=await DeviceOrientationEvent.requestPermission();
    if(r==='granted'){gyroOk=true;window.addEventListener('deviceorientation',onDO,true);}
  }catch(e){}
  window.addEventListener('orientationchange',()=>{screenOri=window.orientation||0;});
  launch();
}

function onDO(e){
  if(e.alpha===null) return;
  gyroOk=true; devA=e.alpha||0; devB=e.beta||0; devG=e.gamma||0;
}

// ‚îÄ‚îÄ LAUNCH THREE.JS ‚îÄ‚îÄ
function launch(){
  document.getElementById('splash').style.display='none';
  document.getElementById('aw').style.display='block';
  screenOri=window.orientation||0;

  const canvas=document.getElementById('tc');
  renderer=new THREE.WebGLRenderer({canvas,alpha:true,antialias:true});
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setClearColor(0x000000,0);

  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.01,100);
  scene.add(camera);
  scene.add(new THREE.AmbientLight(0xffffff,1.4));
  const dl=new THREE.DirectionalLight(0xffffff,.6); dl.position.set(1,2,1); scene.add(dl);

  buildMesh();
  window.addEventListener('resize',onResize);
  animId=requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ BUILD MESH ‚îÄ‚îÄ
function buildMesh(){
  if(imgMesh){scene.remove(imgMesh);imgMesh=null;}
  let tex;
  if(userSrc&&limg.complete&&limg.naturalWidth>0){
    tex=new THREE.Texture(limg); tex.needsUpdate=true;
  } else if(userSrc){
    limg.onload=()=>buildMesh(); return;
  } else {
    tex=new THREE.CanvasTexture(mkDefault());
  }
  const aspect=(limg.naturalWidth/limg.naturalHeight)||1.78;
  const w=imgScale, h=w/aspect;
  imgMesh=new THREE.Mesh(
    new THREE.PlaneGeometry(w,h),
    new THREE.MeshBasicMaterial({map:tex,side:THREE.DoubleSide,transparent:true})
  );
  imgMesh.position.set(0,0,-1.5);
  scene.add(imgMesh);
}

// ‚îÄ‚îÄ LOOP ‚îÄ‚îÄ
function loop(){
  // Update camera from gyro
  if(gyroOk){
    _euler.set(THREE.MathUtils.degToRad(devB),THREE.MathUtils.degToRad(devA),THREE.MathUtils.degToRad(-devG),'YXZ');
    camera.quaternion.setFromEuler(_euler);
    camera.quaternion.multiply(_q1);
    camera.quaternion.multiply(_q0.setFromAxisAngle(_zee,-THREE.MathUtils.degToRad(screenOri)));
  }

  // Pre-place: follow camera center
  if(!isPlaced&&imgMesh){
    const dir=new THREE.Vector3(0,0,-1.5).applyQuaternion(camera.quaternion);
    imgMesh.position.copy(dir);
    imgMesh.quaternion.copy(camera.quaternion);
    if(imgRotOff!==0){
      const qe=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),imgRotOff*Math.PI/180);
      imgMesh.quaternion.multiply(qe);
    }
    if(imgFlipped){
      const qf=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);
      imgMesh.quaternion.multiply(qf);
    }
  }
  // After place: imgMesh stays frozen in world space ‚Äî nothing to update

  renderer.render(scene,camera);
  animId=requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ PLACE ‚îÄ‚îÄ
function placeImage(){
  if(!imgMesh) return;
  isPlaced=true;
  const sb=document.getElementById('sbadge');
  sb.textContent='TEMPEL ‚úì'; sb.style.cssText='background:rgba(40,200,100,.3);border-color:rgba(60,220,120,.4);color:#6fffa0;border-radius:50px;padding:4px 12px;font-size:11px;font-weight:600;';
  document.getElementById('sh').textContent='‚úÖ Gerakkan HP ‚Äî gambar tetap di tempat!';
  document.getElementById('ch').style.opacity='0';
  document.getElementById('plbtn').style.display='none';
  document.getElementById('undobtn').style.display='flex';
  const pb=document.getElementById('pb'); pb.style.display='block';
  setTimeout(()=>{pb.style.transition='opacity .8s';pb.style.opacity='0';setTimeout(()=>{pb.style.display='none';pb.style.opacity='1';pb.style.transition='';},900);},2500);
}

function undoPlace(){
  isPlaced=false;
  const sb=document.getElementById('sbadge'); sb.textContent='PREVIEW'; sb.style.cssText='';
  sb.className='tbb';
  document.getElementById('sh').textContent='Arahkan ke dinding ‚Üí tekan Tempel di Sini';
  document.getElementById('ch').style.opacity='1';
  document.getElementById('plbtn').style.display='flex';
  document.getElementById('undobtn').style.display='none';
}

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ
function onSlSz(v){ imgScale=.15+(v/100)*2.5; if(imgMesh){const a=(limg.naturalWidth/limg.naturalHeight)||1.78;imgMesh.geometry.dispose();imgMesh.geometry=new THREE.PlaneGeometry(imgScale,imgScale/a);} }
function onSlRt(v){ imgRotOff=parseFloat(v); }
function doFlip(){ imgFlipped=!imgFlipped; }

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
function savePhoto(){
  const sc=document.createElement('canvas'); sc.width=window.innerWidth; sc.height=window.innerHeight;
  const sx=sc.getContext('2d');
  sx.drawImage(document.getElementById('cam'),0,0,sc.width,sc.height);
  renderer.render(scene,camera);
  sx.drawImage(document.getElementById('tc'),0,0);
  const a=document.createElement('a'); a.download='ar-3d.jpg'; a.href=sc.toDataURL('image/jpeg',.93); a.click();
}

// ‚îÄ‚îÄ RESIZE ‚îÄ‚îÄ
function onResize(){
  camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
}

// ‚îÄ‚îÄ STOP ‚îÄ‚îÄ
function stopAR(){
  cancelAnimationFrame(animId); animId=null;
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}
  window.removeEventListener('deviceorientation',onDO,true);
  window.removeEventListener('resize',onResize);
  if(renderer){renderer.dispose();renderer=null;}
  scene=null;camera=null;imgMesh=null;isPlaced=false;gyroOk=false;imgFlipped=false;imgScale=.7;imgRotOff=0;
  document.getElementById('aw').style.display='none';
  document.getElementById('splash').style.display='flex';
  document.getElementById('sbadge').textContent='PREVIEW'; document.getElementById('sbadge').style.cssText='';
  document.getElementById('sh').textContent='Arahkan ke dinding ‚Üí tekan Tempel di Sini';
  document.getElementById('ch').style.opacity='1';
  document.getElementById('plbtn').style.display='flex';
  document.getElementById('undobtn').style.display='none';
  document.getElementById('slsz').value=35; document.getElementById('slrt').value=0;
}

// ‚îÄ‚îÄ DEFAULT IMG ‚îÄ‚îÄ
function mkDefault(){
  const c=document.createElement('canvas'); c.width=800; c.height=450;
  const x=c.getContext('2d');
  const g=x.createLinearGradient(0,0,800,450);
  g.addColorStop(0,'#3a1ddd'); g.addColorStop(.5,'#a020dd'); g.addColorStop(1,'#dd3060');
  x.fillStyle=g; x.fillRect(0,0,800,450);
  x.strokeStyle='rgba(255,255,255,.1)'; x.lineWidth=1;
  for(let i=0;i<800;i+=50){x.beginPath();x.moveTo(i,0);x.lineTo(i,450);x.stroke();}
  for(let i=0;i<450;i+=50){x.beginPath();x.moveTo(0,i);x.lineTo(800,i);x.stroke();}
  x.fillStyle='rgba(255,255,255,.92)'; x.font='bold 68px Helvetica'; x.textAlign='center'; x.fillText('AR 3D IMAGE',400,210);
  x.font='24px Helvetica'; x.fillStyle='rgba(255,255,255,.55)'; x.fillText('Pilih foto dari menu utama',400,270);
  return c;
}
</script>
</body>
</html>
