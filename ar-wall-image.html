<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>AR Wall Image</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  body{background:#000;font-family:'Segoe UI',system-ui,sans-serif;color:#fff;overflow:hidden;width:100vw;height:100dvh;}

  /* â”€â”€ SPLASH â”€â”€ */
  #splash{
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    height:100dvh;padding:28px;gap:20px;
    background:radial-gradient(ellipse at 50% 10%,#1c1040 0%,#080810 65%);
  }
  .icon{font-size:52px;margin-bottom:4px;filter:drop-shadow(0 0 20px #7755ff88);}
  h1{font-size:24px;font-weight:800;letter-spacing:-0.5px;text-align:center;background:linear-gradient(135deg,#aa88ff,#ff77cc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .sub{font-size:13px;color:#777;text-align:center;line-height:1.6;max-width:300px;}

  .card{
    background:#111118;border:1px solid #222235;border-radius:18px;
    padding:18px;width:100%;max-width:360px;
  }
  .card-label{font-size:11px;color:#666;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:10px;}

  .preview-box{
    width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;
    background:#0c0c14;border:2px dashed #222235;
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;transition:border-color .2s;position:relative;
  }
  .preview-box:hover{border-color:#7755ff;}
  .preview-box img{width:100%;height:100%;object-fit:cover;display:none;}
  .ph{display:flex;flex-direction:column;align-items:center;gap:6px;color:#444;font-size:12px;}
  .ph .pi{font-size:30px;}
  input[type=file]{display:none;}

  .start-btn{
    background:linear-gradient(135deg,#5533ff,#9944ee);
    border:none;color:#fff;border-radius:16px;
    padding:16px;font-size:16px;font-weight:700;
    cursor:pointer;width:100%;max-width:360px;
    transition:opacity .2s,transform .1s;
    letter-spacing:0.2px;
    box-shadow:0 4px 24px #7733ff44;
  }
  .start-btn:active{transform:scale(0.97);opacity:.9;}

  .badge-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  .badge{background:#111118;border:1px solid #222235;border-radius:50px;padding:6px 14px;font-size:11px;color:#888;}
  .badge span{color:#aaf;margin-right:4px;}

  /* â”€â”€ AR SCREEN â”€â”€ */
  #ar-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;}

  video#cam{
    position:absolute;top:0;left:0;width:100%;height:100%;
    object-fit:cover;z-index:1;
  }

  canvas#overlay{
    position:absolute;top:0;left:0;width:100%;height:100%;
    z-index:2;touch-action:none;
  }

  /* Top bar */
  #topbar{
    position:absolute;top:0;left:0;right:0;z-index:10;
    padding:16px 20px 12px;
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(to bottom,rgba(0,0,0,.6),transparent);
    pointer-events:none;
  }
  .tb-title{font-size:15px;font-weight:700;letter-spacing:.3px;}
  .tb-close{
    background:rgba(255,255,255,.12);backdrop-filter:blur(8px);
    border:1px solid rgba(255,255,255,.15);color:#fff;
    border-radius:50px;padding:7px 16px;font-size:13px;cursor:pointer;
    pointer-events:all;
  }

  /* Bottom controls */
  #controls{
    position:absolute;bottom:0;left:0;right:0;z-index:10;
    padding:20px 20px 36px;
    background:linear-gradient(to top,rgba(0,0,0,.7),transparent);
    display:flex;flex-direction:column;gap:14px;
    align-items:center;
  }

  .ctrl-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;}

  .ctrl-btn{
    background:rgba(255,255,255,.13);backdrop-filter:blur(12px);
    border:1px solid rgba(255,255,255,.18);color:#fff;
    border-radius:50px;padding:11px 18px;
    font-size:13px;font-weight:600;cursor:pointer;
    transition:background .15s;white-space:nowrap;
  }
  .ctrl-btn:active{background:rgba(255,255,255,.28);}
  .ctrl-btn.accent{background:rgba(100,60,255,.5);border-color:rgba(120,80,255,.5);}
  .ctrl-btn.danger{background:rgba(200,30,30,.4);border-color:rgba(220,50,50,.4);}

  .slider-wrap{
    display:flex;align-items:center;gap:10px;
    background:rgba(0,0,0,.4);backdrop-filter:blur(10px);
    border:1px solid rgba(255,255,255,.12);border-radius:50px;
    padding:9px 18px;width:100%;max-width:340px;
  }
  .slider-wrap label{font-size:11px;color:#aaa;white-space:nowrap;min-width:42px;}
  input[type=range]{
    flex:1;-webkit-appearance:none;height:3px;
    background:rgba(255,255,255,.25);border-radius:10px;outline:none;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
    background:linear-gradient(135deg,#7755ff,#cc55ff);
    box-shadow:0 0 8px #7755ff88;cursor:pointer;
  }

  #hint{
    position:absolute;bottom:200px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,.6);backdrop-filter:blur(10px);
    border:1px solid rgba(255,255,255,.12);border-radius:50px;
    padding:10px 22px;font-size:13px;color:#ddd;
    white-space:nowrap;z-index:10;
    transition:opacity .6s;pointer-events:none;
  }
</style>
</head>
<body>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SPLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="splash">
  <div class="icon">ğŸ–¼ï¸</div>
  <h1>AR Wall Image</h1>
  <p class="sub">Tempel gambar ke dinding secara real-time lewat kamera HP kamu.</p>

  <div class="card">
    <div class="card-label">Pilih Gambar</div>
    <div class="preview-box" onclick="document.getElementById('fi').click()">
      <div class="ph" id="ph"><span class="pi">ğŸ“‚</span>Ketuk untuk pilih foto</div>
      <img id="prevImg"/>
    </div>
    <input type="file" id="fi" accept="image/*" onchange="onFileChange(event)"/>
  </div>

  <button class="start-btn" onclick="startAR()">ğŸ“· Mulai AR</button>

  <div class="badge-row">
    <div class="badge"><span>âœ…</span>iOS Safari</div>
    <div class="badge"><span>âœ…</span>Android Chrome</div>
    <div class="badge"><span>âœ…</span>Tanpa install app</div>
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AR SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="ar-screen">
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>

  <div id="hint">ğŸ‘† Geser gambar â€¢ Cubit untuk resize/rotasi</div>

  <div id="topbar">
    <div class="tb-title">ğŸ–¼ï¸ AR Wall Image</div>
    <div class="tb-close" onclick="stopAR()">âœ• Keluar</div>
  </div>

  <div id="controls">
    <div class="slider-wrap">
      <label>ğŸ“ Ukuran</label>
      <input type="range" id="sizeSlider" min="5" max="95" value="40" oninput="onSizeSlider(this.value)"/>
    </div>
    <div class="slider-wrap">
      <label>ğŸ”„ Rotasi</label>
      <input type="range" id="rotSlider" min="0" max="360" value="0" oninput="onRotSlider(this.value)"/>
    </div>
    <div class="ctrl-row">
      <div class="ctrl-btn" onclick="resetImage()">â†º Reset</div>
      <div class="ctrl-btn" onclick="flipImage()">â‡„ Flip</div>
      <div class="ctrl-btn accent" onclick="savePhoto()">ğŸ’¾ Simpan</div>
      <div class="ctrl-btn danger" onclick="stopAR()">âœ• Keluar</div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let imgSrc = null;
let camStream = null;
let imgX, imgY, imgW = 300, imgRot = 0, imgFlip = false;
const loadedImg = new Image();
let canvas, ctx, canvasW, canvasH, animId;

// Touch / drag state
let dragging = false, dragOffX = 0, dragOffY = 0;
let lastPinchDist = 0, lastPinchAngle = 0;
let pinching = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE PICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onFileChange(e) {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  imgSrc = url;
  loadedImg.src = url;
  const prev = document.getElementById('prevImg');
  prev.src = url;
  prev.style.display = 'block';
  document.getElementById('ph').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START AR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startAR() {
  if (!imgSrc) {
    loadedImg.src = buildDefaultImg();
  }

  try {
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } },
      audio: false
    });
  } catch(err) {
    alert('Tidak bisa akses kamera.\n' + err.message);
    return;
  }

  const video = document.getElementById('cam');
  video.srcObject = camStream;
  await video.play();

  document.getElementById('splash').style.display = 'none';
  document.getElementById('ar-screen').style.display = 'block';

  canvas = document.getElementById('overlay');
  ctx = canvas.getContext('2d');

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 300));

  imgX = canvasW / 2;
  imgY = canvasH / 2;
  imgW = canvasW * 0.4;

  // Mouse events (desktop)
  canvas.addEventListener('mousedown', onMD);
  canvas.addEventListener('mousemove', onMM);
  canvas.addEventListener('mouseup', () => { dragging = false; });

  // Touch events (mobile)
  canvas.addEventListener('touchstart', onTS, { passive: false });
  canvas.addEventListener('touchmove',  onTM, { passive: false });
  canvas.addEventListener('touchend',   onTE, { passive: false });

  setTimeout(() => { document.getElementById('hint').style.opacity = '0'; }, 3500);

  document.getElementById('sizeSlider').value = 40;
  document.getElementById('rotSlider').value = 0;

  animId = requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resizeCanvas() {
  canvasW = canvas.width  = window.innerWidth;
  canvasH = canvas.height = window.innerHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop() {
  ctx.clearRect(0, 0, canvasW, canvasH);
  if (loadedImg.complete && loadedImg.naturalWidth > 0) {
    const aspect = loadedImg.naturalWidth / loadedImg.naturalHeight || 1.78;
    const h = imgW / aspect;

    ctx.save();
    ctx.translate(imgX, imgY);
    ctx.rotate(imgRot * Math.PI / 180);
    if (imgFlip) ctx.scale(-1, 1);

    // Drop shadow
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    ctx.shadowBlur  = 24;
    ctx.shadowOffsetX = 8;
    ctx.shadowOffsetY = 8;

    ctx.drawImage(loadedImg, -imgW/2, -h/2, imgW, h);
    ctx.restore();

    // Handles
    drawHandles(h);
  }
  animId = requestAnimationFrame(loop);
}

function drawHandles(h) {
  const corners = [[-imgW/2,-h/2],[imgW/2,-h/2],[imgW/2,h/2],[-imgW/2,h/2]];
  const rad = imgRot * Math.PI / 180;
  const c = Math.cos(rad), s = Math.sin(rad);
  corners.forEach(([cx, cy]) => {
    const rx = imgFlip ? -cx : cx;
    const wx = imgX + rx*c - cy*s;
    const wy = imgY + rx*s + cy*c;
    ctx.beginPath();
    ctx.arc(wx, wy, 8, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(150,120,255,0.9)';
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HIT TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hitTest(px, py) {
  const aspect = (loadedImg.naturalWidth / loadedImg.naturalHeight) || 1.78;
  const h = imgW / aspect;
  const dx = px - imgX, dy = py - imgY;
  const rad = -imgRot * Math.PI / 180;
  const lx = dx*Math.cos(rad) - dy*Math.sin(rad);
  const ly = dx*Math.sin(rad) + dy*Math.cos(rad);
  return Math.abs(lx) < imgW/2 + 24 && Math.abs(ly) < h/2 + 24;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOUSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onMD(e) {
  const {x,y} = mPos(e);
  if (hitTest(x,y)) { dragging=true; dragOffX=x-imgX; dragOffY=y-imgY; }
}
function onMM(e) {
  if (!dragging) return;
  const {x,y} = mPos(e);
  imgX = x-dragOffX; imgY = y-dragOffY;
}
function mPos(e) {
  const r = canvas.getBoundingClientRect();
  return {x:e.clientX-r.left, y:e.clientY-r.top};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOUCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onTS(e) {
  e.preventDefault();
  const t = e.touches;
  if (t.length === 1) {
    pinching = false;
    const p = tPos(t[0]);
    if (hitTest(p.x, p.y)) {
      dragging = true;
      dragOffX = p.x - imgX;
      dragOffY = p.y - imgY;
    } else {
      dragging = false;
    }
  }
  if (t.length === 2) {
    dragging = false;
    pinching = true;
    const p1 = tPos(t[0]), p2 = tPos(t[1]);
    lastPinchDist  = dist(p1, p2);
    lastPinchAngle = ang(p1, p2);
  }
}

function onTM(e) {
  e.preventDefault();
  const t = e.touches;
  if (t.length === 1 && dragging && !pinching) {
    const p = tPos(t[0]);
    imgX = p.x - dragOffX;
    imgY = p.y - dragOffY;
  }
  if (t.length === 2 && pinching) {
    const p1 = tPos(t[0]), p2 = tPos(t[1]);
    const d = dist(p1, p2);
    const a = ang(p1, p2);
    // Scale
    const scaleFactor = d / lastPinchDist;
    imgW = Math.max(60, Math.min(canvasW*1.4, imgW * scaleFactor));
    // Rotate
    imgRot += a - lastPinchAngle;
    lastPinchDist  = d;
    lastPinchAngle = a;
    syncSliders();
  }
}

function onTE(e) {
  if (e.touches.length < 2) pinching = false;
  if (e.touches.length === 0) dragging = false;
}

function tPos(t) {
  const r = canvas.getBoundingClientRect();
  return {x: t.clientX-r.left, y: t.clientY-r.top};
}
function dist(a,b) { return Math.hypot(b.x-a.x, b.y-a.y); }
function ang(a,b)  { return Math.atan2(b.y-a.y, b.x-a.x) * 180/Math.PI; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SLIDER CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onSizeSlider(v) { imgW = canvasW * (v/100); }
function onRotSlider(v)  { imgRot = parseFloat(v); }
function syncSliders() {
  document.getElementById('sizeSlider').value = Math.min(95, Math.max(5, imgW/canvasW*100));
  document.getElementById('rotSlider').value  = ((imgRot%360)+360)%360;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetImage() {
  imgX=canvasW/2; imgY=canvasH/2;
  imgW=canvasW*0.4; imgRot=0; imgFlip=false;
  document.getElementById('sizeSlider').value=40;
  document.getElementById('rotSlider').value=0;
}

function flipImage() { imgFlip = !imgFlip; }

async function savePhoto() {
  const sc = document.createElement('canvas');
  sc.width = canvasW; sc.height = canvasH;
  const sx = sc.getContext('2d');
  sx.drawImage(document.getElementById('cam'), 0, 0, canvasW, canvasH);
  sx.drawImage(canvas, 0, 0);
  const link = document.createElement('a');
  link.download = 'ar-wall-image.jpg';
  link.href = sc.toDataURL('image/jpeg', 0.93);
  link.click();
}

function stopAR() {
  cancelAnimationFrame(animId);
  if (camStream) { camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  document.getElementById('ar-screen').style.display='none';
  document.getElementById('splash').style.display='flex';
  document.getElementById('hint').style.opacity='1';
  window.removeEventListener('resize', resizeCanvas);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULT IMAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDefaultImg() {
  const c = document.createElement('canvas');
  c.width=800; c.height=500;
  const x = c.getContext('2d');
  const g = x.createLinearGradient(0,0,800,500);
  g.addColorStop(0,'#5522ff'); g.addColorStop(.5,'#cc22ee'); g.addColorStop(1,'#ff6622');
  x.fillStyle=g; x.fillRect(0,0,800,500);
  x.strokeStyle='rgba(255,255,255,0.12)';
  for(let i=0;i<800;i+=40){x.beginPath();x.moveTo(i,0);x.lineTo(i,500);x.stroke();}
  for(let i=0;i<500;i+=40){x.beginPath();x.moveTo(0,i);x.lineTo(800,i);x.stroke();}
  x.fillStyle='rgba(255,255,255,0.88)';
  x.font='bold 64px Arial'; x.textAlign='center';
  x.fillText('AR IMAGE', 400, 230);
  x.font='24px Arial'; x.fillStyle='rgba(255,255,255,0.55)';
  x.fillText('Pilih foto dari menu utama', 400, 290);
  return c.toDataURL();
}
</script>
</body>
</html>
